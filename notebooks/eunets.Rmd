---
title: "EU Research Collaboration Networks"
author: "Joao Martins"
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=here::here('docs', 'index.html')) })
output:
  html_document:
    code_folding: show
    toc: true
    theme: united
    highlight: tango
    toc_float: true
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(janitor)
library(countrycode)
library(igraph)
library(here)
library(knitr)
library(conflicted)
source(here::here("R", "global.R"))
conflict_prefer("filter", "dplyr")

df <- 
  here("data-raw", "cordis-h2020projects.csv") %>%
  read_csv2() %>% 
  clean_names()
```

# Data

See [`README.md`](https://github.com/zambujo/eunets/).

# Goal

Try reproducing the following figure:

![doi: 10.1038/d41586-019-01566-z](https://media.nature.com/lw800/magazine-assets/d41586-019-01566-z/d41586-019-01566-z_16737728.png)


# Data Preparation

```{r reprod, message=FALSE, warning=FALSE}

collab <- df %>%
  select(id,
         coordinator_country,
         participant_countries)%>%
  unite(
    country,
    c("coordinator_country", 
      "participant_countries"),
    sep = ";",
    na.rm = TRUE
  ) %>%
  mutate(country = str_split(country, ";")) %>%
  unnest(country) %>%
  filter(country != "NA")

country_sel <- c(eu15, eu13, other)
ncountries_pproj <- collab %>%
  count(id)

# remove one-country projects
collab <- collab %>%
  semi_join(filter(ncountries_pproj, n > 1), by = "id") %>%
  filter(country %in% country_sel)

# start year of each project
year_table <- df %>%
  select(id, year = start_date) %>%
  mutate(year = str_sub(year, 1, 4)) %>%
  arrange(id)

collab_matrix <- collab %>%
  filter(country %in% country_sel) %>%
  calculate_adjacency_matrix()

kable(collab_matrix)
```

# Horizon 2020 network

```{r network, fig.width=7, fig.height=7, message=FALSE, warning=FALSE}
g_collab <- collab_matrix %>%
      igraph::graph_from_adjacency_matrix(
      mode = "undirected",
      weighted = TRUE)

g <- igraph::simplify(g_collab) # remove self-loops
# igraph::strength(g_collab) - 2 * diag(collab_matrix)
vertex_size <- igraph::strength(g)
edge_weight <- igraph::E(g)$weight

lout <- igraph::layout_with_fr(g, weights = (edge_weight)^(1/4))
colnames(lout) <- c("x", "y")

vdf <- lout %>%
  as_tibble() %>%
  mutate(
    country = names(igraph::V(g)),
    status = "Other",
    status = ifelse(country %in% eu15, "EU15", status),
    status = ifelse(country %in% eu13, "EU13", status),
    country_name = countrycode(country, "eurostat", "country.name"),
    weight = vertex_size,
    s = weight / 100
  )

# create separate rules to mimic network representation
edf_all <- g %>%
  get.data.frame() %>%
  as_tibble() %>%
  left_join(select(vdf, x:country), by = c("from" = "country")) %>%
  rename(from_x = x, from_y = y) %>%
  left_join(select(vdf, x:country), by = c("to" = "country")) %>%
  rename(to_x = x, to_y = y) %>%
  mutate(s = (weight / 1000) ^ 2.5)

threshold <- 1
edf_multiple <- edf_all %>%
  filter(s > threshold)

edf_single <- edf_all %>%
  filter(s <= threshold)
edf_single_copy <- edf_single %>%
  rename(from = to, to = from) %>%
  select(from, everything())
edf_single <- edf_single %>%
  bind_rows(edf_single_copy) %>%
  anti_join(edf_multiple, by = "from") %>%
  anti_join(edf_multiple, by = c("from" = "to")) %>%
  group_by(from) %>%
  top_n(1, s) %>%
  mutate(s = .001)

edf <- edf_multiple %>%
  bind_rows(edf_single) %>%
  arrange(s)

ggplot() +
  geom_segment(data = edf,
               aes(
                 x = from_x,
                 xend = to_x,
                 y = from_y,
                 yend = to_y,
                 size = s,
                 colour = s
               )) +
  scale_color_gradient(low = rgb(.9,.9,.9,1), high = rgb(.1,.1,.1,1)) +
  geom_point(data = vdf,
             aes(x, y, size = s, fill = status),
             colour = rgb(1, 1, 1, .5),
             pch=21) +
  # https://colorhunt.co/palette/180404
  scale_fill_manual(values = c("#40bad5", "#035aa6", "#fcbf1e")) +
  geom_text_repel(
    data = vdf,
    aes(x, y, label = country_name),
    bg.color = rgb(1, 1, 1, .5),
    bg.r = 0.15
  ) +
  labs(
    title = "Force-Directed Graph of H2020 Collaboration",
    subtitle = "Country Participation in H2020 Projects from 2014 to 2020",
    caption = "Source: CORDIS"
  ) +
  theme_bw() +
  theme(
    plot.title.position = "plot",
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()
  )
```
