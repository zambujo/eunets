---
title: "H2020 Country Collaboration Network"
author: "Joao Martins"
knit: (function(inputFile, encoding) {
         rmarkdown::render(inputFile,
                           encoding = encoding,
                           output_file = here::here("docs",
                                                    "index.html"))})
output:
  html_document:
    code_folding: hide
    self_contained: false
    toc: true
    theme: united
    highlight: tango
    toc_float: true
editor_options:
  chunk_output_type: console
---

```{r, include=FALSE}
# credits: https://colorhunt.co/palette/180404
colorhunt <- c("#fcbf1e", "#40bad5", "#035aa6")
knitr::opts_chunk$set(echo = TRUE)
## run `R/gather.R` to update the data
## run `R/clean.R` to prepare the data
```

## Goal

Reproduce and update the [following figure](https://www.nature.com/articles/d41586-019-01566-z):

![doi: 10.1038/d41586-019-01566-z](https://media.nature.com/lw800/magazine-assets/d41586-019-01566-z/d41586-019-01566-z_16737728.png)

## Data

CORDIS project data available on the [EU Open Data Portal](https://data.europa.eu/euodp/en/data/dataset/cordisH2020projects). More details in [`README.md`](https://github.com/zambujo/eunets/).
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(scales)
library(janitor)
library(countrycode)
library(wbstats)
library(igraph)
library(yaml)
library(here)
library(knitr)
library(conflicted)
conflict_prefer("filter", "dplyr")

df <-
  here("data", "h2020.csv") %>%
  read_csv() %>%
  clean_names()
```

### Data Cleaning

Below, we transform the raw data to calculate an adjacency matrix containing pairwise counts for the number of times countries participate in projects jointly, either as project coordinators or participants.

```{r, message=FALSE, warning=FALSE}

df <- df %>%
  # remove single-country projects and other countries
  filter(!is.na(group), nunique > 1) %>%
  select(rcn,
         country,
         group)

info_countries <- df %>%
  distinct(country, group) %>%
  arrange(country)

# building the graph ------------------------------------------------------

# adjacency matrix
collaborations <- df %>%
  select(rcn, country) %>%
  table() %>%
  crossprod()

g_collab <- collaborations %>%
  igraph::graph_from_adjacency_matrix(mode = "undirected",
                                      weighted = TRUE)
# remove same-country collaboration (diagonal 2x)
g <- igraph::simplify(g_collab)
node_size <-   igraph::strength(g) # ignore same-country collaboration
edge_weight <- igraph::E(g)$weight

point_coordinates <- igraph::layout_with_fr(g, weights = edge_weight)
colnames(point_coordinates) <- c("x", "y")

nodes <- 
  point_coordinates %>%
  as_tibble() %>%
  mutate(country = names(igraph::V(g))) %>%
  left_join(info_countries, by = "country") %>%
  mutate(
    status = str_to_upper(group),
    country_name = countrycode(country, "eurostat", "country.name"),
    s = node_size
  ) %>%
  arrange(s)

edges <- get.data.frame(g) %>%
  as_tibble() %>%
  left_join(select(nodes, x:country), by = c("from" = "country")) %>%
  rename(from_x = x, from_y = y) %>%
  left_join(select(nodes, x:country), by = c("to" = "country")) %>%
  rename(to_x = x, to_y = y) %>%
  mutate(s = weight) %>%
  arrange(s)
```

## Horizon 2020 Network

### Unabridged

```{r, fig.width=9, fig.height=9, message=FALSE, warning=FALSE}
ggplot() +
  geom_segment(
    data = edges,
    aes(
      x = from_x,
      xend = to_x,
      y = from_y,
      yend = to_y,
      size = s,
      colour = s
    ),
    show.legend = FALSE
  ) +
  scale_color_gradient(low = rgb(0, 0, 0, .05), 
                       high = rgb(0, 0, 0, .45)) +
  geom_point(
    data = nodes,
    aes(x, y, size = s, fill = status),
    pch = 21,
    colour = "white"
  ) +
  scale_fill_manual(values = colorhunt) +
  scale_size(range = c(.25, 5)) +
  guides(
    fill = guide_legend(override.aes = list(size = 7, shape = 21)),
    color = "none",
    size = "none") +
  geom_text_repel(
    data = nodes,
    aes(x, y, label = country_name),
    size = 5.5,
    segment.color = NA,
    bg.color = "white",
    bg.r = 0.15
  ) +
  labs(title = "Force-Directed Graph of H2020 Collaborations",
       subtitle = "EU Countries + 7 Others, 2014-2020",
       caption = "Source: CORDIS") +
  theme_bw() +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(size = 25, face = "bold"),
    plot.subtitle = element_text(size = 18),
    plot.caption = element_text(size = 10),
    legend.position = c(.95, .95),
    legend.title = element_blank(),
    legend.text = element_text(size = 16),
    legend.key.size = unit(2, "lines"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()
  )

```

### Pruned


```{r network, fig.width=9, fig.height=9, message=FALSE, warning=FALSE}
# re-calculate layout on log-scale of edge weight

# spread core:
point_coordinates <- g %>%
  #  edge weight
  igraph::layout_with_fr(weights = log(edge_weight))
colnames(point_coordinates) <- c("x", "y")

nodes <- 
  point_coordinates %>%
  as_tibble() %>%
  mutate(country = names(igraph::V(g))) %>%
  left_join(info_countries, by = "country") %>%
  mutate(
    status = str_to_upper(group),
    country_name = countrycode(country, "eurostat", "country.name"),
    s = node_size
  ) %>%
  arrange(s)

edges <- g %>%
  get.data.frame() %>%
  as_tibble() %>%
  left_join(select(nodes, x:country), by = c("from" = "country")) %>%
  rename(from_x = x, from_y = y) %>%
  left_join(select(nodes, x:country), by = c("to" = "country")) %>%
  rename(to_x = x, to_y = y) %>%
  mutate(s = (weight / 1000) ^ 2.5) %>% # ad-hoc
  arrange(s)

# separate rules to approach Nature's representation
threshold <- 1 # ad-hoc
core_edges <- edges %>%
  filter(s > threshold)
outer_edges <- edges %>%
  filter(s <= threshold)
outer_edges_reversed <- outer_edges %>%
  rename(from = to, to = from) %>%
  select(from, everything())
outer_edges <- outer_edges %>%
  bind_rows(outer_edges_reversed) %>%
  anti_join(core_edges, by = "from") %>%
  anti_join(core_edges, by = c("from" = "to")) %>%
  group_by(from) %>%
  top_n(1, s) %>%
  mutate(s = 1)

edges <- core_edges %>%
  bind_rows(outer_edges) %>%
  arrange(s) # plot stronger edges last

ggplot() +
  geom_segment(
    data = edges,
    aes(
      x = from_x,
      xend = to_x,
      y = from_y,
      yend = to_y,
      size = s,
      colour = s
    ),
    show.legend = FALSE
  ) +
  scale_color_gradient(low = "gray90", high = "gray45") +
  geom_point(
    data = nodes,
    aes(x, y, size = s, fill = status),
    pch = 21,
    colour = "white"
  ) +
  scale_fill_manual(values = colorhunt) +
  scale_size(range = c(.75, 16)) +
  guides(
    fill = guide_legend(override.aes = list(size = 7, shape = 21)),
    color = "none",
    size = "none") +
  geom_text_repel(
    data = nodes,
    aes(x, y, label = country_name),
    size = 5.5,
    force = 3,
    segment.color = NA,
    box.padding = unit(.8, "lines"),
    bg.color = "white",
    bg.r = 0.15
  ) +
  labs(title = "Log-Force-Directed Graph of H2020 Collaborations",
       subtitle = "EU Countries + 7 Others, 2014-2020",
       caption = "Source: CORDIS") +
  theme_bw() +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(size = 25, face = "bold"),
    plot.subtitle = element_text(size = 18),
    plot.caption = element_text(size = 10),
    legend.position = c(.95, .95),
    legend.title = element_blank(),
    legend.text = element_text(size = 16),
    legend.key.size = unit(2, "lines"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()
  )
```

---

## Population Size

Below, a log-log scale updated representation of Figure 2 from *[Network dynamics in collaborative research in the EU, 2003â€“2017](https://www.tandfonline.com/doi/figure/10.1080/09654313.2019.1641187)*.

```{r, fig.width=9, fig.height=7, message=FALSE, warning=FALSE}
population_table <- wbstats::wb_data(
  indicator = "SP.POP.TOTL",
  country = countrycode(pull(info_countries, country), "eurostat", "iso2c"),
  start_date = 2017,
  end_date = 2017
) %>%
  clean_names() %>%
  select(iso2c, population = sp_pop_totl)

nodes <- nodes %>%
  # for world bank compatibility
  mutate(iso2c = countrycode(country, "eurostat", "iso2c")) %>%
  left_join(population_table, by = "iso2c")

ggplot(aes(population, s, label = country_name, col = status),
       data = nodes) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    col = "gray75",
    linetype = "dotted",
    size = .5
  ) +
  geom_point(size = 3, alpha = .8) +
  geom_text_repel(
    size = 5,
    force = 2,
    segment.alpha = 0.5,
    bg.color = rgb(1, 1, 1, .5),
    bg.r = 0.15,
    show.legend = FALSE
  ) +
  scale_color_manual(values = colorhunt) +
  scale_y_log10(labels = label_number(accuracy = 1, scale = 1e-3)) +
  scale_x_log10(labels = label_number(accuracy = 1, scale = 1e-6)) +
  labs(
    title = "H2020 Collaborations by Population",
    subtitle = "Shown in log-log scale",
    caption = "Source: CORDIS, World Bank",
    color = element_blank(),
    x = "Population (mio)",
    y = "No. Collaborations (k)"
  ) +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    legend.position = c(.1, .96),
    legend.direction = "horizontal",
    legend.key.size = unit(4, "mm"),
    legend.background = element_rect(
      linetype = "dotted",
      fill = alpha("white", 1),
      color = alpha("black", 0.25)
    )
  )
```
