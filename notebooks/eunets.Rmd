---
title: "H2020 Country Collaboration Network"
author: "Joao Martins"
knit: (function(inputFile, encoding) {
         rmarkdown::render(inputFile,
                           encoding = encoding,
                           output_file = here::here("docs",
                                                    "index.html"))})
output:
  html_document:
    code_folding: show
    toc: true
    theme: united
    highlight: tango
    toc_float: true
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r, include=FALSE}
update_data <- TRUE
# credits: https://colorhunt.co/palette/180404
colorhunt <- c("#40bad5", "#035aa6", "#fcbf1e")
knitr::opts_chunk$set(echo = TRUE)
```

## Goal

Reproduce and update the [following figure](https://www.nature.com/articles/d41586-019-01566-z):

![doi: 10.1038/d41586-019-01566-z](https://media.nature.com/lw800/magazine-assets/d41586-019-01566-z/d41586-019-01566-z_16737728.png)

## Data

CORDIS project data available on the [EU Open Data Portal](https://data.europa.eu/euodp/en/data/dataset/cordisH2020projects). More details in [`README.md`](https://github.com/zambujo/eunets/).
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(scales)
library(janitor)
library(countrycode)
library(wbstats)
library(igraph)
library(yaml)
library(here)
library(knitr)
library(conflicted)
conflict_prefer("filter", "dplyr")

if (update_data) {
  download.file(
    "https://cordis.europa.eu/data/cordis-h2020projects.csv",
    here("data-raw", "cordis-h2020projects.csv"))
}
df <-
  here("data-raw", "cordis-h2020projects.csv") %>%
  read_csv2() %>%
  clean_names()
```

### Data Cleaning

Below, we transform the raw data to calculate an adjacency matrix containing pairwise counts for the number of times countries participate in projects jointly, either as project coordinators or participants.

```{r, message=FALSE, warning=FALSE}
country_selection <- read_yaml(here("countries.yml"))
eu15 <-  pluck(country_selection, "eu15")
eu13 <-  pluck(country_selection, "eu13")
other <- pluck(country_selection, "other")
country_selection <- flatten_chr(country_selection)

collaborations <- 
  df %>%
  select(id,
         coordinator_country,
         participant_countries) %>%
  unite(
    country,
    c("coordinator_country",
      "participant_countries"),
    sep = ";",
    na.rm = TRUE
  ) %>%
  mutate(country = str_split(country, ";")) %>%
  unnest(country) %>%
  filter(country %in% country_selection)

number_countries <- collaborations %>%
  group_by(id) %>%
  summarise(n = n_distinct(country),
            .groups = "drop")

collaborations <- collaborations %>%
  # remove single-country projects
  semi_join(filter(number_countries, n > 1), by = "id")

# adjacency matrix
collaborations <- 
  collaborations %>%
  table() %>%
  crossprod()
```

---

## Horizon 2020 Network
```{r network, fig.width=9, fig.height=9, message=FALSE, warning=FALSE}
g_collab <- 
  collaborations %>%
  igraph::graph_from_adjacency_matrix(mode = "undirected", 
                                      weighted = TRUE)

g <- igraph::simplify(g_collab) # remove diagonal 2x
node_size <-   igraph::strength(g)
edge_weight <- igraph::E(g)$weight

point_coordinates <- g %>%
  # ad-hoc edge weight tweaking
  igraph::layout_with_fr(weights = edge_weight ^ (1 / 5))
colnames(point_coordinates) <- c("x", "y")

nodes <- point_coordinates %>%
  as_tibble() %>%
  mutate(
    country = names(igraph::V(g)),
    status = NA_character_,
    status = ifelse(country %in% eu15, "EU15", status),
    status = ifelse(country %in% eu13, "EU13", status),
    status = ifelse(country %in% other, "Other", status),
    country_name = countrycode(country, "eurostat", "country.name"),
    weight = node_size,
    s = weight / 100 # ad-hoc
  )

edges <- g %>%
  get.data.frame() %>%
  as_tibble() %>%
  left_join(select(nodes, x:country), by = c("from" = "country")) %>%
  rename(from_x = x, from_y = y) %>%
  left_join(select(nodes, x:country), by = c("to" = "country")) %>%
  rename(to_x = x, to_y = y) %>%
  mutate(s = (weight / 1000) ^ 2.5) # ad-hoc

# separate rules to approach Nature's representation
threshold <- 1 # ad-hoc
core_edges <- edges %>%
  filter(s > threshold)
outer_edges <- edges %>%
  filter(s <= threshold)
outer_edges_reversed <- outer_edges %>%
  rename(from = to, to = from) %>%
  select(from, everything())
outer_edges <- outer_edges %>%
  bind_rows(outer_edges_reversed) %>%
  anti_join(core_edges, by = "from") %>%
  anti_join(core_edges, by = c("from" = "to")) %>%
  group_by(from) %>%
  top_n(1, s) %>%
  mutate(s = 1)

edges <- core_edges %>%
  bind_rows(outer_edges) %>%
  arrange(s) # plot stronger edges last

ggplot() +
  geom_segment(
    data = edges,
    aes(
      x = from_x,
      xend = to_x,
      y = from_y,
      yend = to_y,
      size = s,
      colour = s
    ),
    show.legend = FALSE
  ) +
  scale_color_gradient(low = "gray90", high = "gray45") +
  geom_point(
    data = nodes,
    aes(x, y, size = s, fill = status),
    pch = 21,
    colour = "white"
  ) +
  scale_fill_manual(values = colorhunt) +
  scale_size(range = c(.75, 16)) +
  guides(color = FALSE,
         size = FALSE,
         fill = guide_legend(
           override.aes = list(size = 7, shape = 21))) +
  geom_text_repel(
    data = nodes,
    aes(x, y, label = country_name),
    size = 5.5,
    force = 3,
    segment.color = NA,
    box.padding = unit(.8, "lines"),
    bg.color = "white",
    bg.r = 0.15
  ) +
  labs(title = "Force-Directed Graph of H2020 Collaborations",
       subtitle = "EU Countries + 7 Others, 2014-2020",
       caption = "Source: CORDIS") +
  theme_bw() +
  theme(
    plot.title.position = "plot",
    plot.title = element_text(size = 25, face = "bold"),
    plot.subtitle = element_text(size = 18),
    plot.caption = element_text(size = 10),
    legend.position = c(.95, .95),
    legend.title = element_blank(),
    legend.text = element_text(size = 16),
    legend.key.size = unit(2, "lines"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()
  )
```

---

## Collaborations by Population

Below, a log-log scale updated representation of Figure 2 from *[Network dynamics in collaborative research in the EU, 2003â€“2017](https://www.tandfonline.com/doi/figure/10.1080/09654313.2019.1641187)*.

```{r country-size, fig.width=9, fig.height=7, message=FALSE, warning=FALSE}
nodes <- nodes %>%
  # for world bank compatibility
  mutate(iso2c = countrycode(country, "eurostat", "iso2c"))

population_table <- nodes %>%
  pull(iso2c) %>%
  wbstats::wb(
    "SP.POP.TOTL",
    startdate = 2017,
    enddate = 2017,
    return_wide = TRUE
  ) %>%
  clean_names() %>%
  select(iso2c, population = sp_pop_totl)

nodes <- nodes %>%
  left_join(population_table, by = "iso2c")

ggplot(aes(population, weight, label = country_name, col = status),
       data = nodes) +
  geom_smooth(
    method = "lm",
    se = FALSE,
    col = "gray75",
    linetype = "dotted",
    size = .5
  ) +
  geom_point(size = 3, alpha = .8) +
  geom_text_repel(
    size = 5,
    force = 2,
    segment.alpha = 0.5,
    bg.color = rgb(1, 1, 1, .5),
    bg.r = 0.15,
    show.legend = FALSE
  ) +
  scale_color_manual(values = colorhunt) +
  scale_y_log10(labels = label_number(accuracy = 1, scale = 1e-3)) +
  scale_x_log10(labels = label_number(accuracy = 1, scale = 1e-6)) +
  labs(
    title = "H2020 Collaborations by Population",
    subtitle = "Shown in log-log scale",
    caption = "Source: CORDIS, World Bank",
    color = element_blank(),
    x = "Population (mio)",
    y = "No. Collaborations (k)"
  ) +
  theme_minimal() +
  theme(
    plot.title.position = "plot",
    legend.position = c(.1, .96),
    legend.direction = "horizontal",
    legend.key.size = unit(4, "mm"),
    legend.background = element_rect(
      linetype = "dotted",
      fill = alpha("white", 1),
      color = alpha("black", 0.25)
    )
  )
```
