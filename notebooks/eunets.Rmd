---
title: "EU Research Collaboration Networks"
author: "Joao Martins"
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=here::here('docs', 'index.html')) })
output:
  html_document:
    code_folding: show
    toc: true
    theme: united
    highlight: tango
    toc_float: true
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(janitor)
library(countrycode)
library(igraph)
library(here)
library(knitr)
library(conflicted)
source(here::here("R", "global.R"))
conflict_prefer("filter", "dplyr")

df <- 
  here("data-raw", "cordis-h2020projects.csv") %>%
  read_csv2() %>% 
  clean_names()
```

# Data

See [`README.md`](https://github.com/zambujo/editorials).

# Goal

Try reproducing the following figure:

![doi: 10.1038/d41586-019-01566-z](https://media.nature.com/lw800/magazine-assets/d41586-019-01566-z/d41586-019-01566-z_16737728.png)


# Data Preparation

```{r reprod, message=FALSE, warning=FALSE}

collab <- df %>%
  select(id,
         coordinator_country,
         participant_countries)

# assertion:
# Q: coordinator_country in list of participant_countries?
# A: Not always. Add them to the list of participant countries.
# mutate(test = str_detect(participant_countries, coordinator_country)) %>%
# summarise(all(test))

collab <- collab %>%
  unite(
    country,
    c("coordinator_country", "participant_countries"),
    sep = ";",
    na.rm = TRUE
  ) %>%
  mutate(country = str_split(country, ";")) %>%
  unnest(country) %>%
  filter(country != "NA")

ncountries_pproj <- collab %>%
  count(id)

# keep projects with only one country
collab <- collab %>%
  semi_join(filter(ncountries_pproj, n > 1), by = "id")

country_stats <- collab %>%
  count(country, sort = TRUE)

country_stats <- country_stats %>%
  mutate(
    iso2c = countrycode(country, "eurostat", "iso2c", nomatch = NA_character_),
    eu28 = countrycode(iso2c, "iso2c", "eu28", nomatch = "Non-EU")
  )

assoc <- c("CH", "NO", "IL", "TR")
country_sel <-
  country_stats %>%
  filter(eu28 == "EU") %>%
  pull(country) %>%
  c(assoc)

year_table <- df %>%
  select(id, year = start_date) %>%
  mutate(year = str_sub(year, 1, 4)) %>%
  arrange(id)

# show top-6 results
country_stats %>%
  head() %>%
  kable()
```

# Horizon 2020 network

```{r network, fig.width=8, fig.height=8, message=FALSE, warning=FALSE}

g_collab <- collab %>%
  # semi_join(filter(year_table, year == "2015"), by = "id") %>%
  filter(country %in% country_sel) %>%
  df2graph()

vertex_size <- igraph::strength(g_collab)
g <- igraph::simplify(g_collab) # remove self-loops
edge_weight <- igraph::E(g)$weight

# adding sqrt() to mimic results
lout <- igraph::layout_with_fr(g, weights = sqrt(edge_weight))
colnames(lout) <- c("x", "y")

vdf <- lout %>%
  as_tibble() %>%
  mutate(
    country = names(igraph::V(g)),
    weight = vertex_size,
    s = weight / 100,
    eu28 = countrycode(country, "eurostat", "eu28", nomatch = "Non-EU"),
    country_name = countrycode(country, "eurostat", "country.name")
  )

# create separate rules to mimic network representation
edf_all <- g %>%
  get.data.frame() %>%
  as_tibble() %>%
  left_join(select(vdf, x:country), by = c("from" = "country")) %>%
  rename(from_x = x, from_y = y) %>%
  left_join(select(vdf, x:country), by = c("to" = "country")) %>%
  rename(to_x = x, to_y = y) %>%
  mutate(s = (weight / 1000) ^ 2.5)

threshold <- .5
edf_multiple <- edf_all %>%
  filter(s > threshold)

edf_single <- edf_all %>%
  filter(s <= threshold)
edf_single_copy <- edf_single %>%
  rename(from = to, to = from) %>%
  select(from, everything())
edf_single <- edf_single %>%
  bind_rows(edf_single_copy) %>%
  anti_join(edf_multiple, by = "from") %>%
  anti_join(edf_multiple, by = c("from" = "to")) %>%
  group_by(from) %>%
  top_n(1, s) %>%
  mutate(s = .001)

edf <- edf_multiple %>%
  bind_rows(edf_single) %>%
  arrange(s)

ggplot() +
  geom_segment(data = edf,
               aes(
                 x = from_x,
                 xend = to_x,
                 y = from_y,
                 yend = to_y,
                 size = s,
                 colour = s
               )) +
  scale_color_gradient(low = rgb(0,0,0,.1), high = rgb(0,0,0,.75)) +
  geom_point(data = vdf,
             aes(x, y, size = s, fill = eu28),
             colour = rgb(1, 1, 1, .5),
             pch=21) +
  scale_fill_manual(values = c("#035aa6", "#fcbf1e")) +
  geom_text_repel(
    data = vdf,
    aes(x, y, label = country_name),
    bg.color = rgb(1, 1, 1, .5),
    bg.r = 0.15
  ) +
  labs(
    title = "Force-Directed Graph of H2020 Collaboration",
    subtitle = "Country Participation in H2020 Projects from 2014 to 2020",
    caption = "Source: CORDIS"
  ) +
  theme_bw() +
  theme(
    plot.title.position = "plot",
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()
  )
```
